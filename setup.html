<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸƒâ€â™‚ï¸ è‡ªåŠ¨è·‘æ­¥è„šæœ¬ - ä¸€é”®è®¾ç½®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }

        .step h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .account-section {
            background: #fff;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .account-title {
            font-weight: 600;
            color: #333;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .remove-btn:hover {
            background: #ff3742;
        }

        .add-account-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .add-account-btn:hover {
            background: #3d8bfe;
        }

        .submit-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .github-token-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .github-token-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .github-token-section p {
            color: #856404;
            font-size: 14px;
            line-height: 1.5;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .help-text {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .help-text h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .help-text ul {
            color: #1976d2;
            padding-left: 20px;
        }

        .help-text li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸƒâ€â™‚ï¸ è‡ªåŠ¨è·‘æ­¥è„šæœ¬</h1>
            <p>ä¸€é”®è®¾ç½®ï¼Œè‡ªåŠ¨è¿è¡Œï¼Œå®Œå…¨å…è´¹ï¼</p>
        </div>

        <div class="content">
            <div class="step">
                <h3>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šè·å–GitHub Token</h3>
                <div class="github-token-section">
                    <h4>ğŸ”‘ å¦‚ä½•è·å–GitHub Tokenï¼Ÿ</h4>
                    <p>
                        1. ç‚¹å‡»å³ä¸Šè§’å¤´åƒ â†’ <strong>Settings</strong><br>
                        2. å·¦ä¾§èœå•æ‰¾åˆ° <strong>Developer settings</strong><br>
                        3. ç‚¹å‡» <strong>Personal access tokens</strong> â†’ <strong>Tokens (classic)</strong><br>
                        4. ç‚¹å‡» <strong>Generate new token</strong> â†’ <strong>Generate new token (classic)</strong><br>
                        5. å¡«å†™åç§°ï¼Œé€‰æ‹© <strong>repo</strong> æƒé™ï¼Œç‚¹å‡» <strong>Generate token</strong><br>
                        6. å¤åˆ¶ç”Ÿæˆçš„tokenï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼ï¼‰
                    </p>
                </div>
                <div class="form-group">
                    <label for="githubToken">GitHub Tokenï¼š</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                </div>
            </div>

            <div class="step">
                <h3>ğŸ“ ç¬¬äºŒæ­¥ï¼šç®¡ç†è´¦å·ä¿¡æ¯</h3>
                <p style="margin-bottom: 20px; color: #666;">æ”¯æŒæœ€å¤š5ä¸ªè´¦å·ï¼Œå¯ä»¥æŸ¥çœ‹ã€ä¿®æ”¹æˆ–æ·»åŠ æ–°è´¦å·</p>
                
                <div style="margin-bottom: 20px;">
                    <button type="button" class="add-account-btn" onclick="loadExistingAccounts()">
                        ğŸ” æŸ¥çœ‹å·²è®¾ç½®çš„è´¦å·
                    </button>
                    <button type="button" class="add-account-btn" onclick="addNewAccount()" style="background: #28a745;">
                        â• æ·»åŠ æ–°è´¦å·
                    </button>
                </div>
                
                <div id="accountsContainer">
                    <!-- è´¦å·è¡¨å•ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="step">
                <h3>ğŸš€ ç¬¬ä¸‰æ­¥ï¼šä¿å­˜è®¾ç½®</h3>
                <button type="button" class="submit-btn" onclick="submitToGitHub()">
                    ğŸ’¾ ä¿å­˜è´¦å·ä¿¡æ¯åˆ°GitHub
                </button>
                <button type="button" class="submit-btn" onclick="deleteAllSecrets()" style="background: #dc3545; margin-top: 10px;">
                    ğŸ—‘ï¸ åˆ é™¤æ‰€æœ‰è´¦å·ä¿¡æ¯
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨è®¾ç½®GitHub Secretsï¼Œè¯·ç¨å€™...</p>
            </div>

            <div class="status" id="status"></div>

            <div class="help-text">
                <h4>ğŸ’¡ è®¾ç½®å®Œæˆåï¼š</h4>
                <ul>
                    <li>è„šæœ¬ä¼šæ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹è‡ªåŠ¨è¿è¡Œ</li>
                    <li>ä½ å¯ä»¥åœ¨GitHubä»“åº“çš„Actionsé¡µé¢æŸ¥çœ‹è¿è¡Œç»“æœ</li>
                    <li>æ”¯æŒéšæ—¶æ‰‹åŠ¨è§¦å‘è¿è¡Œ</li>
                    <li>æ‰€æœ‰è´¦å·å¯†ç éƒ½å®‰å…¨å­˜å‚¨åœ¨GitHubä¸­</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let accountCount = 0;

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            // ä¸è‡ªåŠ¨æ·»åŠ è´¦å·ï¼Œè®©ç”¨æˆ·é€‰æ‹©æŸ¥çœ‹ç°æœ‰è´¦å·æˆ–æ·»åŠ æ–°è´¦å·
        };

        async function loadExistingAccounts() {
            const githubToken = document.getElementById('githubToken').value.trim();
            if (!githubToken) {
                showStatus('è¯·å…ˆè¾“å…¥GitHub Token', 'error');
                return;
            }

            const repoOwner = prompt('è¯·è¾“å…¥GitHubç”¨æˆ·åï¼ˆä»“åº“æ‰€æœ‰è€…ï¼‰ï¼š');
            const repoName = prompt('è¯·è¾“å…¥GitHubä»“åº“åï¼š');
            
            if (!repoOwner || !repoName) {
                showStatus('è¯·æä¾›å®Œæ•´çš„ä»“åº“ä¿¡æ¯', 'error');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            
            try {
                const accounts = await getExistingAccounts(githubToken, repoOwner, repoName);
                displayAccounts(accounts);
                showStatus(`âœ… æˆåŠŸåŠ è½½ ${accounts.length} ä¸ªå·²è®¾ç½®çš„è´¦å·`, 'success');
            } catch (error) {
                showStatus(`âŒ åŠ è½½å¤±è´¥ï¼š${error.message}`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function getExistingAccounts(token, owner, repo) {
            const accounts = [];
            
            // æ£€æŸ¥æ¯ä¸ªå¯èƒ½çš„è´¦å·ä½ç½®
            for (let i = 1; i <= 5; i++) {
                try {
                    const usernameResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/secrets/ACCOUNT${i}_USERNAME`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (usernameResponse.ok) {
                        // è·å–å¯†ç 
                        const passwordResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/secrets/ACCOUNT${i}_PASSWORD`, {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (passwordResponse.ok) {
                            // æ³¨æ„ï¼šGitHub APIä¸è¿”å›secretçš„å€¼ï¼Œåªèƒ½çŸ¥é“æ˜¯å¦å­˜åœ¨
                            accounts.push({
                                index: i,
                                username: `è´¦å·${i}ï¼ˆå·²è®¾ç½®ï¼‰`,
                                password: '******',
                                isExisting: true
                            });
                        }
                    }
                } catch (error) {
                    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ª
                }
            }
            
            return accounts;
        }

        function displayAccounts(accounts) {
            const container = document.getElementById('accountsContainer');
            container.innerHTML = '';
            accountCount = 0;

            accounts.forEach(account => {
                accountCount++;
                const accountDiv = document.createElement('div');
                accountDiv.className = 'account-section';
                accountDiv.id = `account-${accountCount}`;

                accountDiv.innerHTML = `
                    <div class="account-header">
                        <span class="account-title">è´¦å· ${account.index} ${account.isExisting ? '(å·²è®¾ç½®)' : ''}</span>
                        <button type="button" class="remove-btn" onclick="removeAccount(${accountCount})">åˆ é™¤</button>
                    </div>
                    <div class="form-group">
                        <label for="username${accountCount}">ç”¨æˆ·åï¼ˆæ‰‹æœºå·æˆ–é‚®ç®±ï¼‰ï¼š</label>
                        <input type="text" id="username${accountCount}" value="${account.username}" placeholder="è¯·è¾“å…¥æ‰‹æœºå·æˆ–é‚®ç®±">
                    </div>
                    <div class="form-group">
                        <label for="password${accountCount}">å¯†ç ï¼š</label>
                        <input type="password" id="password${accountCount}" value="${account.password}" placeholder="è¯·è¾“å…¥å¯†ç ">
                        <small style="color: #666; font-size: 12px;">${account.isExisting ? 'ï¼ˆå¯†ç å·²éšè—ï¼Œå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥ï¼‰' : ''}</small>
                    </div>
                `;

                container.appendChild(accountDiv);
            });
        }

        function addNewAccount() {
            if (accountCount >= 5) {
                alert('æœ€å¤šæ”¯æŒ5ä¸ªè´¦å·');
                return;
            }

            accountCount++;
            const container = document.getElementById('accountsContainer');
            const accountDiv = document.createElement('div');
            accountDiv.className = 'account-section';
            accountDiv.id = `account-${accountCount}`;

            accountDiv.innerHTML = `
                <div class="account-header">
                    <span class="account-title">æ–°è´¦å· ${accountCount}</span>
                    <button type="button" class="remove-btn" onclick="removeAccount(${accountCount})">åˆ é™¤</button>
                </div>
                <div class="form-group">
                    <label for="username${accountCount}">ç”¨æˆ·åï¼ˆæ‰‹æœºå·æˆ–é‚®ç®±ï¼‰ï¼š</label>
                    <input type="text" id="username${accountCount}" placeholder="è¯·è¾“å…¥æ‰‹æœºå·æˆ–é‚®ç®±">
                </div>
                <div class="form-group">
                    <label for="password${accountCount}">å¯†ç ï¼š</label>
                    <input type="password" id="password${accountCount}" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
            `;

            container.appendChild(accountDiv);
        }

        function removeAccount(accountNum) {
            const accountDiv = document.getElementById(`account-${accountNum}`);
            if (accountDiv) {
                accountDiv.remove();
            }
        }

        async function submitToGitHub() {
            const githubToken = document.getElementById('githubToken').value.trim();
            if (!githubToken) {
                showStatus('è¯·å…ˆè¾“å…¥GitHub Token', 'error');
                return;
            }

            // æ”¶é›†è´¦å·ä¿¡æ¯
            const accounts = [];
            for (let i = 1; i <= accountCount; i++) {
                const username = document.getElementById(`username${i}`).value.trim();
                const password = document.getElementById(`password${i}`).value.trim();
                
                if (username && password && !username.includes('ï¼ˆå·²è®¾ç½®ï¼‰')) {
                    accounts.push({
                        username: username,
                        password: password,
                        index: i
                    });
                }
            }

            if (accounts.length === 0) {
                showStatus('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªæœ‰æ•ˆçš„è´¦å·ä¿¡æ¯', 'error');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.querySelector('.submit-btn').disabled = true;

            try {
                // è·å–ä»“åº“ä¿¡æ¯
                const repoOwner = prompt('è¯·è¾“å…¥GitHubç”¨æˆ·åï¼ˆä»“åº“æ‰€æœ‰è€…ï¼‰ï¼š');
                const repoName = prompt('è¯·è¾“å…¥GitHubä»“åº“åï¼š');
                
                if (!repoOwner || !repoName) {
                    showStatus('è¯·æä¾›å®Œæ•´çš„ä»“åº“ä¿¡æ¯', 'error');
                    return;
                }

                // è®¾ç½®GitHub Secrets
                for (const account of accounts) {
                    await setGitHubSecret(githubToken, repoOwner, repoName, 
                        `ACCOUNT${account.index}_USERNAME`, account.username);
                    await setGitHubSecret(githubToken, repoOwner, repoName, 
                        `ACCOUNT${account.index}_PASSWORD`, account.password);
                }

                showStatus(`âœ… æˆåŠŸä¿å­˜ ${accounts.length} ä¸ªè´¦å·ä¿¡æ¯ï¼<br>
                    ğŸ“ è´¦å·ä¿¡æ¯å·²å®‰å…¨å­˜å‚¨åœ¨GitHubä¸­<br>
                    ğŸ”„ å¦‚éœ€ä¿®æ”¹ï¼Œè¯·é‡æ–°æ‰“å¼€æ­¤é¡µé¢å¹¶ç‚¹å‡»"æŸ¥çœ‹å·²è®¾ç½®çš„è´¦å·"`, 'success');

            } catch (error) {
                showStatus(`âŒ ä¿å­˜å¤±è´¥ï¼š${error.message}`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.submit-btn').disabled = false;
            }
        }

        async function deleteAllSecrets() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è´¦å·ä¿¡æ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            const githubToken = document.getElementById('githubToken').value.trim();
            if (!githubToken) {
                showStatus('è¯·å…ˆè¾“å…¥GitHub Token', 'error');
                return;
            }

            const repoOwner = prompt('è¯·è¾“å…¥GitHubç”¨æˆ·åï¼ˆä»“åº“æ‰€æœ‰è€…ï¼‰ï¼š');
            const repoName = prompt('è¯·è¾“å…¥GitHubä»“åº“åï¼š');
            
            if (!repoOwner || !repoName) {
                showStatus('è¯·æä¾›å®Œæ•´çš„ä»“åº“ä¿¡æ¯', 'error');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.querySelector('.submit-btn').disabled = true;

            try {
                // åˆ é™¤æ‰€æœ‰å¯èƒ½çš„è´¦å·secrets
                for (let i = 1; i <= 5; i++) {
                    try {
                        await deleteGitHubSecret(githubToken, repoOwner, repoName, `ACCOUNT${i}_USERNAME`);
                        await deleteGitHubSecret(githubToken, repoOwner, repoName, `ACCOUNT${i}_PASSWORD`);
                    } catch (error) {
                        // å¿½ç•¥åˆ é™¤å¤±è´¥çš„é”™è¯¯
                    }
                }

                showStatus('âœ… æ‰€æœ‰è´¦å·ä¿¡æ¯å·²åˆ é™¤', 'success');
                document.getElementById('accountsContainer').innerHTML = '';
                accountCount = 0;

            } catch (error) {
                showStatus(`âŒ åˆ é™¤å¤±è´¥ï¼š${error.message}`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.submit-btn').disabled = false;
            }
        }

        async function deleteGitHubSecret(token, owner, repo, secretName) {
            const url = `https://api.github.com/repos/${owner}/${repo}/actions/secrets/${secretName}`;
            
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok && response.status !== 404) {
                throw new Error(`åˆ é™¤Secretå¤±è´¥ï¼š${response.status} ${response.statusText}`);
            }
        }

        async function setGitHubSecret(token, owner, repo, secretName, secretValue) {
            const url = `https://api.github.com/repos/${owner}/${repo}/actions/secrets/${secretName}`;
            
            // é¦–å…ˆè·å–ä»“åº“å…¬é’¥
            const publicKeyResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/secrets/public-key`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!publicKeyResponse.ok) {
                throw new Error(`è·å–å…¬é’¥å¤±è´¥ï¼š${publicKeyResponse.status}`);
            }

            const publicKeyData = await publicKeyResponse.json();
            
            // åŠ å¯†secretå€¼
            const encryptedValue = await encryptSecret(secretValue, publicKeyData.key);
            
            // è®¾ç½®secret
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    encrypted_value: encryptedValue,
                    key_id: publicKeyData.key_id
                })
            });

            if (!response.ok) {
                throw new Error(`è®¾ç½®Secretå¤±è´¥ï¼š${response.status} ${response.statusText}`);
            }
        }

        async function encryptSecret(secret, publicKey) {
            // è¿™é‡Œéœ€è¦ä½¿ç”¨Web Crypto APIæ¥åŠ å¯†
            // ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œè¿™ä¸ªåŠŸèƒ½éœ€è¦åœ¨æœåŠ¡å™¨ç«¯å®ç°
            // æˆ–è€…ä½¿ç”¨GitHubçš„å®¢æˆ·ç«¯åº“
            throw new Error('åŠ å¯†åŠŸèƒ½éœ€è¦åœ¨æœåŠ¡å™¨ç«¯å®ç°ï¼Œè¯·ä½¿ç”¨GitHub CLIæˆ–å…¶ä»–å·¥å…·');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
    </script>
</body>
</html>
